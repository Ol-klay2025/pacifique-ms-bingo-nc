<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MS BINGO - Statistiques et Analyses</title>
    
    <!-- Charger D3.js pour les visualisations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        body {
            font-family: 'Trebuchet MS', Arial, sans-serif;
            background-color: #1a1a1a;
            color: white;
            margin: 0;
            padding: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%230099cc" fill-opacity="0.1" d="M0,96L48,112C96,128,192,160,288,186.7C384,213,480,235,576,224C672,213,768,171,864,165.3C960,160,1056,192,1152,208C1248,224,1344,224,1392,224L1440,224L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
            background-repeat: no-repeat;
            background-position: bottom;
            background-size: 100% 50%;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #0099cc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1, h2, h3, h4 {
            margin: 0;
            color: white;
        }
        
        h1 {
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        h2 {
            color: #0099cc;
            margin-bottom: 15px;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        
        nav {
            display: flex;
            gap: 10px;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        nav a:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        nav a.active {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .stats-card {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .stats-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #0099cc;
            display: flex;
            align-items: center;
        }
        
        .stats-title i {
            margin-right: 8px;
            font-size: 20px;
        }
        
        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        
        .stats-row:last-child {
            border-bottom: none;
        }
        
        .stats-label {
            color: #ccc;
        }
        
        .stats-value {
            font-weight: bold;
        }
        
        .stats-value.positive {
            color: #4CAF50;
        }
        
        .stats-value.negative {
            color: #F44336;
        }
        
        .stats-value.neutral {
            color: #FF9800;
        }
        
        /* Styles pour les graphiques */
        .chart-container {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .chart-container h3 {
            margin-bottom: 15px;
            color: #0099cc;
        }
        
        .chart-inner {
            background-color: #333;
            border-radius: 5px;
            padding: 10px;
            height: 300px;
        }
        
        /* Styles pour les tableaux */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .stats-table th, .stats-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #444;
        }
        
        .stats-table th {
            background-color: #222;
            color: #0099cc;
        }
        
        .stats-table tr:hover {
            background-color: #333;
        }
        
        /* Styles pour les numéros */
        .number-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 5px;
            margin-top: 10px;
        }
        
        .number-cell {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            background-color: #333;
        }
        
        .number-cell.hot {
            background-color: #F44336;
            color: white;
        }
        
        .number-cell.cold {
            background-color: #2196F3;
            color: white;
        }
        
        /* Styles pour les recommandations */
        .recommendations {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
            border-left: 4px solid #FFC107;
        }
        
        .recommendations h2 {
            color: #FFC107;
            border-bottom-color: #FFC107;
        }
        
        .recommendation-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #444;
        }
        
        .recommendation-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .recommendation-title {
            font-weight: bold;
            color: #FFC107;
            margin-bottom: 5px;
        }
        
        .recommendation-numbers {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        
        /* Boutons d'action */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: #0099cc;
            color: white;
        }
        
        .btn-warning {
            background-color: #FFC107;
            color: #333;
        }
        
        .btn-danger {
            background-color: #F44336;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        /* Modal de confirmation */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-backdrop.active {
            display: flex;
        }
        
        .modal-content {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            margin-bottom: 15px;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Styles pour les onglets */
        .tabs {
            display: flex;
            background-color: #222;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            margin-bottom: 0;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #222;
            color: #ccc;
            flex: 1;
            text-align: center;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            background-color: #333;
        }
        
        .tab.active {
            background-color: #2a2a2a;
            color: #0099cc;
            border-bottom-color: #0099cc;
        }
        
        .tab-content {
            display: none;
            background-color: #2a2a2a;
            border-radius: 0 0 8px 8px;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>MS BINGO</h1>
            <nav>
                <a href="/profile">Profil</a>
                <a href="/play">Jouer</a>
                <a href="/social">Social</a>
                <a href="/statistics" class="active">Statistiques</a>
                <a href="/logout" id="logout-btn">Déconnexion</a>
            </nav>
        </header>
        
        <h2>Analyses et Statistiques Détaillées</h2>
        
        <div class="tabs">
            <div class="tab active" data-tab="performance">Performance</div>
            <div class="tab" data-tab="numbers">Numéros</div>
            <div class="tab" data-tab="patterns">Tendances</div>
            <div class="tab" data-tab="history">Historique</div>
        </div>
        
        <!-- Onglet Performance -->
        <div id="performance-tab" class="tab-content active">
            <div class="stats-grid">
                <div class="stats-card">
                    <div class="stats-title">
                        <i>🏆</i> Statistiques de jeu
                    </div>
                    <div class="stats-row">
                        <div class="stats-label">Parties jouées</div>
                        <div class="stats-value" id="games-played">0</div>
                    </div>
                    <div class="stats-row">
                        <div class="stats-label">Parties gagnées</div>
                        <div class="stats-value" id="games-won">0</div>
                    </div>
                    <div class="stats-row">
                        <div class="stats-label">Taux de victoire</div>
                        <div class="stats-value" id="win-rate">0%</div>
                    </div>
                    <div class="stats-row">
                        <div class="stats-label">Quines réalisées</div>
                        <div class="stats-value" id="quines-achieved">0</div>
                    </div>
                    <div class="stats-row">
                        <div class="stats-label">Taux de quine</div>
                        <div class="stats-value" id="quine-rate">0%</div>
                    </div>
                    <div class="stats-row">
                        <div class="stats-label">Temps moyen pour une quine</div>
                        <div class="stats-value" id="avg-quine-time">0:00</div>
                    </div>
                    <div class="stats-row">
                        <div class="stats-label">Temps moyen pour un bingo</div>
                        <div class="stats-value" id="avg-bingo-time">0:00</div>
                    </div>
                    <div class="stats-row">
                        <div class="stats-label">Gains totaux</div>
                        <div class="stats-value positive" id="total-winnings">0,00 €</div>
                    </div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-title">
                        <i>📊</i> Performance relative
                    </div>
                    <div id="performance-chart" class="chart-inner">
                        <!-- Le graphique de performance sera inséré ici par D3.js -->
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>Évolution des résultats</h3>
                <div id="results-timeline" class="chart-inner">
                    <!-- Le graphique d'évolution sera inséré ici par D3.js -->
                </div>
            </div>
        </div>
        
        <!-- Onglet Numéros -->
        <div id="numbers-tab" class="tab-content">
            <div class="stats-grid">
                <div class="stats-card">
                    <div class="stats-title">
                        <i>🔥</i> Numéros "chauds" (les plus tirés)
                    </div>
                    <div class="number-grid" id="hot-numbers">
                        <!-- Les numéros chauds seront insérés ici -->
                    </div>
                    <div class="stats-table-container">
                        <table class="stats-table">
                            <thead>
                                <tr>
                                    <th>Numéro</th>
                                    <th>Colonne</th>
                                    <th>Fréquence</th>
                                </tr>
                            </thead>
                            <tbody id="hot-numbers-table">
                                <!-- Les numéros chauds seront insérés ici -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-title">
                        <i>❄️</i> Numéros "froids" (les moins tirés)
                    </div>
                    <div class="number-grid" id="cold-numbers">
                        <!-- Les numéros froids seront insérés ici -->
                    </div>
                    <div class="stats-table-container">
                        <table class="stats-table">
                            <thead>
                                <tr>
                                    <th>Numéro</th>
                                    <th>Colonne</th>
                                    <th>Fréquence</th>
                                </tr>
                            </thead>
                            <tbody id="cold-numbers-table">
                                <!-- Les numéros froids seront insérés ici -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>Distribution des fréquences par colonne</h3>
                <div id="column-distribution" class="chart-inner">
                    <!-- Le graphique de distribution sera inséré ici par D3.js -->
                </div>
            </div>
        </div>
        
        <!-- Onglet Tendances -->
        <div id="patterns-tab" class="tab-content">
            <div class="stats-grid">
                <div class="stats-card">
                    <div class="stats-title">
                        <i>📈</i> Tendances de tirage
                    </div>
                    <div class="stats-row">
                        <div class="stats-label">Colonne la plus fréquente</div>
                        <div class="stats-value" id="most-frequent-column">-</div>
                    </div>
                    <div class="stats-row">
                        <div class="stats-label">Colonne la moins fréquente</div>
                        <div class="stats-value" id="least-frequent-column">-</div>
                    </div>
                    <div class="stats-row">
                        <div class="stats-label">Max. tirages consécutifs</div>
                        <div class="stats-value" id="most-consecutive-draws">-</div>
                    </div>
                    <div class="stats-row">
                        <div class="stats-label">Jour le plus actif</div>
                        <div class="stats-value" id="most-active-day">-</div>
                    </div>
                    <div class="stats-row">
                        <div class="stats-label">Heure la plus active</div>
                        <div class="stats-value" id="most-active-hour">-</div>
                    </div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-title">
                        <i>🎯</i> Analyse des objectifs
                    </div>
                    <div id="goals-chart" class="chart-inner">
                        <!-- Le graphique d'objectifs sera inséré ici par D3.js -->
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>Répartition des tirages dans le temps</h3>
                <div id="time-heatmap" class="chart-inner">
                    <!-- La heatmap sera insérée ici par D3.js -->
                </div>
            </div>
        </div>
        
        <!-- Onglet Historique -->
        <div id="history-tab" class="tab-content">
            <div class="stats-card">
                <div class="stats-title">
                    <i>📜</i> Historique récent
                </div>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Durée</th>
                            <th>Quine</th>
                            <th>Numéros tirés</th>
                            <th>Résultat</th>
                        </tr>
                    </thead>
                    <tbody id="recent-games">
                        <!-- L'historique des parties sera inséré ici -->
                    </tbody>
                </table>
            </div>
            
            <div class="chart-container">
                <h3>Progression des performances</h3>
                <div id="performance-progress" class="chart-inner">
                    <!-- Le graphique de progression sera inséré ici par D3.js -->
                </div>
            </div>
        </div>
        
        <!-- Recommandations basées sur les statistiques -->
        <div class="recommendations">
            <h2>Recommandations Personnalisées</h2>
            
            <div id="recommendations-container">
                <!-- Les recommandations seront insérées ici -->
            </div>
        </div>
        
        <!-- Boutons d'action -->
        <div class="action-buttons">
            <button class="btn btn-primary" id="refresh-btn">Rafraîchir les données</button>
            <button class="btn btn-danger" id="reset-btn">Réinitialiser les statistiques</button>
        </div>
        
        <!-- Modal de confirmation -->
        <div class="modal-backdrop" id="reset-confirm-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Confirmation</h3>
                </div>
                <div class="modal-body">
                    <p>Êtes-vous sûr de vouloir réinitialiser toutes vos statistiques ? Cette action est irréversible.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="cancel-reset-btn">Annuler</button>
                    <button class="btn btn-danger" id="confirm-reset-btn">Réinitialiser</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charger le module d'analyse statistique -->
    <script src="/js/statistics-analyzer.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier si le module d'analyse statistique est disponible
            if (!window.msBingoStats) {
                console.error('Le module d\'analyse statistique n\'est pas disponible');
                return;
            }
            
            // Initialiser les onglets
            initTabs();
            
            // Afficher les statistiques
            displayStats();
            
            // Créer les graphiques
            createCharts();
            
            // Afficher les recommandations
            displayRecommendations();
            
            // Configurer les gestionnaires d'événements
            setupEventListeners();
        });
        
        /**
         * Initialise les onglets
         */
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Retirer la classe active de tous les onglets
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Activer l'onglet cliqué
                    tab.classList.add('active');
                    const tabId = `${tab.dataset.tab}-tab`;
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        /**
         * Affiche les statistiques
         */
        function displayStats() {
            const stats = window.msBingoStats.getDisplayStats();
            
            // Afficher les statistiques de performance
            document.getElementById('games-played').textContent = stats.player.gamesPlayed;
            document.getElementById('games-won').textContent = stats.player.gamesWon;
            document.getElementById('win-rate').textContent = stats.player.winRate;
            document.getElementById('quines-achieved').textContent = stats.player.quinesAchieved;
            document.getElementById('quine-rate').textContent = stats.player.quineRate;
            document.getElementById('avg-quine-time').textContent = stats.player.avgTimeToQuine;
            document.getElementById('avg-bingo-time').textContent = stats.player.avgTimeToBingo;
            document.getElementById('total-winnings').textContent = stats.player.totalWinnings;
            
            // Afficher les tendances
            if (stats.patterns.mostFrequentColumn) {
                document.getElementById('most-frequent-column').textContent = 
                    `${stats.patterns.mostFrequentColumn.column} (${stats.patterns.mostFrequentColumn.total})`;
            }
            
            if (stats.patterns.leastFrequentColumn) {
                document.getElementById('least-frequent-column').textContent = 
                    `${stats.patterns.leastFrequentColumn.column} (${stats.patterns.leastFrequentColumn.total})`;
            }
            
            if (stats.patterns.mostConsecutiveDraws && stats.patterns.mostConsecutiveDraws.column) {
                document.getElementById('most-consecutive-draws').textContent = 
                    `${stats.patterns.mostConsecutiveDraws.count} tirages en ${stats.patterns.mostConsecutiveDraws.column}`;
            }
            
            document.getElementById('most-active-day').textContent = stats.activity.mostActiveDay;
            document.getElementById('most-active-hour').textContent = stats.activity.mostActiveHour;
            
            // Afficher les numéros chauds (les plus tirés)
            const hotNumbersGrid = document.getElementById('hot-numbers');
            const hotNumbersTable = document.getElementById('hot-numbers-table');
            
            hotNumbersGrid.innerHTML = '';
            hotNumbersTable.innerHTML = '';
            
            stats.numbers.mostDrawn.forEach(item => {
                // Ajouter au grid
                const cell = document.createElement('div');
                cell.className = 'number-cell hot';
                cell.textContent = item.number;
                hotNumbersGrid.appendChild(cell);
                
                // Ajouter au tableau
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.number}</td>
                    <td>${item.column}</td>
                    <td>${item.frequency}</td>
                `;
                hotNumbersTable.appendChild(row);
            });
            
            // Afficher les numéros froids (les moins tirés)
            const coldNumbersGrid = document.getElementById('cold-numbers');
            const coldNumbersTable = document.getElementById('cold-numbers-table');
            
            coldNumbersGrid.innerHTML = '';
            coldNumbersTable.innerHTML = '';
            
            stats.numbers.leastDrawn.forEach(item => {
                // Ajouter au grid
                const cell = document.createElement('div');
                cell.className = 'number-cell cold';
                cell.textContent = item.number;
                coldNumbersGrid.appendChild(cell);
                
                // Ajouter au tableau
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.number}</td>
                    <td>${item.column}</td>
                    <td>${item.frequency}</td>
                `;
                coldNumbersTable.appendChild(row);
            });
            
            // Afficher l'historique récent
            const recentGamesTable = document.getElementById('recent-games');
            recentGamesTable.innerHTML = '';
            
            if (stats.activity.recentGames.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5">Aucune partie récente</td>';
                recentGamesTable.appendChild(row);
            } else {
                stats.activity.recentGames.forEach(game => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${game.date}</td>
                        <td>${game.duration}</td>
                        <td>${game.quineTime}</td>
                        <td>${game.numbersDrawn}</td>
                        <td><span class="${game.won ? 'positive' : 'negative'}">${game.won ? 'Gagné' : 'Perdu'}</span></td>
                    `;
                    recentGamesTable.appendChild(row);
                });
            }
        }
        
        /**
         * Affiche les recommandations
         */
        function displayRecommendations() {
            const recommendations = window.msBingoStats.generateRecommendations();
            const container = document.getElementById('recommendations-container');
            container.innerHTML = '';
            
            // Recommendations sur les cartes
            if (recommendations.cards && recommendations.cards.length > 0) {
                recommendations.cards.forEach(cardRec => {
                    const item = document.createElement('div');
                    item.className = 'recommendation-item';
                    
                    let numbersHtml = '';
                    if (cardRec.numbers && cardRec.numbers.length > 0) {
                        numbersHtml = '<div class="recommendation-numbers">';
                        cardRec.numbers.forEach(number => {
                            numbersHtml += `<div class="number-cell ${cardRec.type}">${number}</div>`;
                        });
                        numbersHtml += '</div>';
                    }
                    
                    item.innerHTML = `
                        <div class="recommendation-title">Recommandation de carte</div>
                        <div>${cardRec.message}</div>
                        ${numbersHtml}
                    `;
                    
                    container.appendChild(item);
                });
            }
            
            // Recommendation sur le timing
            if (recommendations.timing) {
                const timingItem = document.createElement('div');
                timingItem.className = 'recommendation-item';
                timingItem.innerHTML = `
                    <div class="recommendation-title">Meilleur moment pour jouer</div>
                    <div>${recommendations.timing}</div>
                `;
                container.appendChild(timingItem);
            }
            
            // Recommendation sur la stratégie
            if (recommendations.strategy) {
                const strategyItem = document.createElement('div');
                strategyItem.className = 'recommendation-item';
                strategyItem.innerHTML = `
                    <div class="recommendation-title">Conseils stratégiques</div>
                    <div>${recommendations.strategy}</div>
                `;
                container.appendChild(strategyItem);
            }
            
            // Si aucune recommandation n'est disponible
            if (container.children.length === 0) {
                container.innerHTML = '<p>Jouez plus de parties pour obtenir des recommandations personnalisées.</p>';
            }
        }
        
        /**
         * Crée les graphiques avec D3.js
         */
        function createCharts() {
            const stats = window.msBingoStats.getDisplayStats();
            
            // Graphique en secteurs pour les performances
            createPerformanceChart(stats);
            
            // Graphique de la répartition des fréquences par colonne
            createColumnDistributionChart();
            
            // Graphique d'évolution des résultats
            createResultsTimelineChart(stats);
            
            // Autres graphiques - ajuster selon les besoins
        }
        
        /**
         * Crée un graphique en secteurs pour les performances
         */
        function createPerformanceChart(stats) {
            // Effacer le contenu précédent
            d3.select('#performance-chart').html('');
            
            // Données pour le graphique
            const data = [
                { label: 'Victoires', value: stats.player.gamesWon, color: '#4CAF50' },
                { label: 'Défaites', value: stats.player.gamesPlayed - stats.player.gamesWon, color: '#F44336' }
            ];
            
            // Si aucune partie n'a été jouée, afficher un message
            if (stats.player.gamesPlayed === 0) {
                d3.select('#performance-chart')
                    .append('div')
                    .style('height', '100%')
                    .style('display', 'flex')
                    .style('align-items', 'center')
                    .style('justify-content', 'center')
                    .style('color', '#ccc')
                    .text('Aucune donnée disponible');
                return;
            }
            
            // Dimensions du graphique
            const width = document.getElementById('performance-chart').clientWidth;
            const height = document.getElementById('performance-chart').clientHeight;
            const radius = Math.min(width, height) / 2 - 40;
            
            // Créer le SVG
            const svg = d3.select('#performance-chart')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${width / 2}, ${height / 2})`);
            
            // Générer le graphique en secteurs
            const pie = d3.pie()
                .value(d => d.value)
                .sort(null);
            
            const arc = d3.arc()
                .innerRadius(radius * 0.5) // Graphique en anneau plutôt qu'en camembert
                .outerRadius(radius);
            
            // Ajouter les segments
            const segments = svg.selectAll('path')
                .data(pie(data))
                .enter()
                .append('path')
                .attr('d', arc)
                .attr('fill', d => d.data.color)
                .attr('stroke', '#222')
                .style('stroke-width', '1px')
                .style('opacity', 0.8);
            
            // Ajouter les étiquettes
            const text = svg.selectAll('text')
                .data(pie(data))
                .enter()
                .append('text')
                .attr('transform', d => `translate(${arc.centroid(d)})`)
                .attr('dy', '.35em')
                .style('text-anchor', 'middle')
                .style('fill', '#fff')
                .style('font-size', '14px')
                .style('font-weight', 'bold')
                .text(d => d.data.value > 0 ? `${d.data.label}: ${d.data.value}` : '');
            
            // Titre central
            svg.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', '0em')
                .style('font-size', '16px')
                .style('fill', '#ccc')
                .text('Résultats');
            
            svg.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', '1.5em')
                .style('font-size', '20px')
                .style('font-weight', 'bold')
                .style('fill', '#0099cc')
                .text(`${stats.player.winRate}`);
        }
        
        /**
         * Crée un graphique de la répartition des fréquences par colonne
         */
        function createColumnDistributionChart() {
            // Effacer le contenu précédent
            d3.select('#column-distribution').html('');
            
            // Données pour le graphique - récupérer les données réelles depuis le module
            // Exemple de format de données attendu: [{ column: 'B', value: 15 }, ...]
            const columnData = [];
            const columns = ['B', 'I', 'N', 'G', 'O'];
            
            for (const column of columns) {
                // Obtenir la fréquence totale pour cette colonne
                const totalFrequency = window.msBingoStats.data.numbers[column].reduce((sum, freq) => sum + freq, 0);
                columnData.push({ column, value: totalFrequency });
            }
            
            // Si aucune donnée n'est disponible, afficher un message
            if (columnData.every(d => d.value === 0)) {
                d3.select('#column-distribution')
                    .append('div')
                    .style('height', '100%')
                    .style('display', 'flex')
                    .style('align-items', 'center')
                    .style('justify-content', 'center')
                    .style('color', '#ccc')
                    .text('Aucune donnée disponible');
                return;
            }
            
            // Dimensions du graphique
            const width = document.getElementById('column-distribution').clientWidth;
            const height = document.getElementById('column-distribution').clientHeight;
            const margin = { top: 30, right: 30, bottom: 40, left: 50 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;
            
            // Créer le SVG
            const svg = d3.select('#column-distribution')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${margin.left}, ${margin.top})`);
            
            // Échelles X et Y
            const x = d3.scaleBand()
                .domain(columns)
                .range([0, innerWidth])
                .padding(0.2);
            
            const y = d3.scaleLinear()
                .domain([0, d3.max(columnData, d => d.value) * 1.1]) // 10% de marge en haut
                .range([innerHeight, 0]);
            
            // Couleurs pour chaque colonne
            const columnColors = {
                'B': '#FF5252', // Rouge
                'I': '#FFCA28', // Jaune
                'N': '#66BB6A', // Vert
                'G': '#42A5F5', // Bleu
                'O': '#BA68C8'  // Violet
            };
            
            // Ajouter les barres
            svg.selectAll('.bar')
                .data(columnData)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('x', d => x(d.column))
                .attr('y', d => y(d.value))
                .attr('width', x.bandwidth())
                .attr('height', d => innerHeight - y(d.value))
                .attr('fill', d => columnColors[d.column])
                .attr('rx', 3) // Coins arrondis
                .attr('ry', 3);
            
            // Ajouter les valeurs au-dessus des barres
            svg.selectAll('.bar-label')
                .data(columnData)
                .enter()
                .append('text')
                .attr('class', 'bar-label')
                .attr('x', d => x(d.column) + x.bandwidth() / 2)
                .attr('y', d => y(d.value) - 5)
                .attr('text-anchor', 'middle')
                .style('fill', '#fff')
                .style('font-size', '12px')
                .text(d => d.value);
            
            // Ajouter l'axe X
            svg.append('g')
                .attr('transform', `translate(0, ${innerHeight})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .style('font-size', '14px')
                .style('font-weight', 'bold')
                .style('fill', d => columnColors[d]);
            
            // Ajouter l'axe Y
            svg.append('g')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .style('fill', '#ccc');
            
            // Titre du graphique
            svg.append('text')
                .attr('x', innerWidth / 2)
                .attr('y', -10)
                .attr('text-anchor', 'middle')
                .style('font-size', '16px')
                .style('fill', '#0099cc')
                .text('Fréquence des tirages par colonne');
        }
        
        /**
         * Crée un graphique d'évolution des résultats
         */
        function createResultsTimelineChart(stats) {
            // Effacer le contenu précédent
            d3.select('#results-timeline').html('');
            
            // Vérifier si des données d'historique sont disponibles
            if (!stats.activity.recentGames || stats.activity.recentGames.length === 0) {
                d3.select('#results-timeline')
                    .append('div')
                    .style('height', '100%')
                    .style('display', 'flex')
                    .style('align-items', 'center')
                    .style('justify-content', 'center')
                    .style('color', '#ccc')
                    .text('Aucune donnée disponible');
                return;
            }
            
            // Préparer les données pour le graphique
            // Convertir l'historique des parties en données de série temporelle
            const gameHistory = window.msBingoStats.data.gameHistory;
            
            if (gameHistory.length < 2) {
                d3.select('#results-timeline')
                    .append('div')
                    .style('height', '100%')
                    .style('display', 'flex')
                    .style('align-items', 'center')
                    .style('justify-content', 'center')
                    .style('color', '#ccc')
                    .text('Jouez plus de parties pour voir l\'évolution');
                return;
            }
            
            // Dimensions du graphique
            const width = document.getElementById('results-timeline').clientWidth;
            const height = document.getElementById('results-timeline').clientHeight;
            const margin = { top: 30, right: 50, bottom: 40, left: 50 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;
            
            // Créer le SVG
            const svg = d3.select('#results-timeline')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${margin.left}, ${margin.top})`);
            
            // Calculer les données cumulatives de victoires
            const cumulativeData = [];
            let winCount = 0;
            
            gameHistory.forEach((game, i) => {
                if (game.won) winCount++;
                cumulativeData.push({
                    index: i,
                    game: i + 1, // Numéro de partie
                    wins: winCount,
                    winRate: (winCount / (i + 1)) * 100
                });
            });
            
            // Échelles X et Y
            const x = d3.scaleLinear()
                .domain([0, gameHistory.length - 1])
                .range([0, innerWidth]);
            
            const y = d3.scaleLinear()
                .domain([0, 100]) // Taux de victoire en pourcentage
                .range([innerHeight, 0]);
            
            // Créer la ligne pour le taux de victoire
            const line = d3.line()
                .x(d => x(d.index))
                .y(d => y(d.winRate))
                .curve(d3.curveMonotoneX);
            
            // Ajouter la ligne
            svg.append('path')
                .datum(cumulativeData)
                .attr('fill', 'none')
                .attr('stroke', '#0099cc')
                .attr('stroke-width', 3)
                .attr('d', line);
            
            // Ajouter les points pour chaque partie
            svg.selectAll('.data-point')
                .data(cumulativeData)
                .enter()
                .append('circle')
                .attr('class', 'data-point')
                .attr('cx', d => x(d.index))
                .attr('cy', d => y(d.winRate))
                .attr('r', 4)
                .attr('fill', '#fff')
                .attr('stroke', '#0099cc')
                .attr('stroke-width', 2);
            
            // Ajouter les étiquettes pour certains points
            const labelIndices = [0, Math.floor(cumulativeData.length / 2), cumulativeData.length - 1];
            
            svg.selectAll('.point-label')
                .data(labelIndices.map(i => cumulativeData[i]))
                .enter()
                .append('text')
                .attr('class', 'point-label')
                .attr('x', d => x(d.index))
                .attr('y', d => y(d.winRate) - 10)
                .attr('text-anchor', 'middle')
                .style('fill', '#ccc')
                .style('font-size', '12px')
                .text(d => `${d.winRate.toFixed(1)}%`);
            
            // Ajouter des lignes de référence
            const referenceLines = [25, 50, 75];
            
            svg.selectAll('.reference-line')
                .data(referenceLines)
                .enter()
                .append('line')
                .attr('class', 'reference-line')
                .attr('x1', 0)
                .attr('x2', innerWidth)
                .attr('y1', d => y(d))
                .attr('y2', d => y(d))
                .attr('stroke', '#444')
                .attr('stroke-dasharray', '3,3');
            
            svg.selectAll('.reference-label')
                .data(referenceLines)
                .enter()
                .append('text')
                .attr('class', 'reference-label')
                .attr('x', innerWidth + 5)
                .attr('y', d => y(d) + 4)
                .style('fill', '#ccc')
                .style('font-size', '12px')
                .text(d => `${d}%`);
            
            // Ajouter l'axe X
            svg.append('g')
                .attr('transform', `translate(0, ${innerHeight})`)
                .call(d3.axisBottom(x).ticks(Math.min(10, gameHistory.length)).tickFormat(d => `#${Math.round(d) + 1}`))
                .selectAll('text')
                .style('fill', '#ccc');
            
            // Ajouter l'axe Y
            svg.append('g')
                .call(d3.axisLeft(y).tickFormat(d => `${d}%`))
                .selectAll('text')
                .style('fill', '#ccc');
            
            // Titre du graphique
            svg.append('text')
                .attr('x', innerWidth / 2)
                .attr('y', -10)
                .attr('text-anchor', 'middle')
                .style('font-size', '16px')
                .style('fill', '#0099cc')
                .text('Évolution du taux de victoire');
        }
        
        /**
         * Configure les gestionnaires d'événements
         */
        function setupEventListeners() {
            // Déconnexion
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                
                fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                }).then(() => {
                    window.location.href = '/';
                }).catch(error => {
                    console.error('Erreur lors de la déconnexion:', error);
                    alert('Erreur lors de la déconnexion');
                });
            });
            
            // Rafraîchir les données
            document.getElementById('refresh-btn').addEventListener('click', () => {
                displayStats();
                createCharts();
                displayRecommendations();
            });
            
            // Réinitialiser les statistiques
            document.getElementById('reset-btn').addEventListener('click', () => {
                // Afficher la modal de confirmation
                document.getElementById('reset-confirm-modal').classList.add('active');
            });
            
            // Annuler la réinitialisation
            document.getElementById('cancel-reset-btn').addEventListener('click', () => {
                document.getElementById('reset-confirm-modal').classList.remove('active');
            });
            
            // Confirmer la réinitialisation
            document.getElementById('confirm-reset-btn').addEventListener('click', () => {
                window.msBingoStats.resetAllStats();
                document.getElementById('reset-confirm-modal').classList.remove('active');
                
                // Actualiser l'affichage
                displayStats();
                createCharts();
                displayRecommendations();
            });
        }
    </script>
</body>
</html>